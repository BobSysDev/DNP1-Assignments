@page "/Comment/{ParentIdFromRoute}/CreateComment"
@using BlazorApp.Services
@using DTOs
@attribute [StreamRendering]
@inject ICommentService CommentService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<h3>Create a new comment under the comment:  @ParentIdFromRoute</h3>
<EditForm Model="@createDto" OnSubmit="@AddSingleComment">
    <div style="margin-bottom: 10px;">
        <div>Your user ID: </div>
        <InputNumber @bind-Value="createDto.UserId" />
    </div>
    <div style="margin-bottom: 10px;">
        <div>Comment body: </div>
        <InputTextArea @bind-Value="createDto.Body"></InputTextArea>
    </div>
    <button class="btn btn-primary" type="submit">Create new comment</button>
</EditForm>

@code {
    [Parameter] public string? ParentIdFromRoute { get; set; }
    private CreateCommentDTO createDto { get; set; } = new CreateCommentDTO();
    
    private async Task AddSingleComment()
    {
        createDto.ParentId = ParentIdFromRoute;
        var createdComment = await CommentService.CreateCommentAsync(createDto);
        var masterParentId = await GetPostIdByAnyChild(createdComment);
        
        NavigationManager.NavigateTo($"/Posts/{masterParentId}");
    }

    private async Task<string> GetPostIdByAnyChild(CommentDTO child)
    {
        if (child.ParentId[0] == 'P')
        {
            return child.ParentId;
        }

        return await GetPostIdByAnyChild(await CommentService.GetSingleCommentByIdAsync(child.ParentId));
    }
}